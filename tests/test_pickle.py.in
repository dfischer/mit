# Test pickling VM state.
#
# (c) Mit authors 2019-2020
#
# The package is distributed under the MIT/X11 License.
#
# THIS PROGRAM IS PROVIDED AS IS, WITH NO WARRANTY. USE IS AT THE USERâ€™S
# RISK.

import pickle

from mit.globals import *


# Load pforth image and run it, defining a new word
load("@top_srcdir@/src/specializer/pforth/src/mit/pforth")
VM.register_args('test', '--evaluate', ': FOO   ." hello!" CR ;')
VM.run()

# Pickle the VM
ir.set(0)
s = pickle.dumps(VM)

# Unpickle the VM
VM2 = pickle.loads(s)
VM2.registers['pc'].set(VM2.registers['memory'].get())
VM2.register_args('test', '--evaluate', 'FOO')
VM2.run()


print("Pickle tests ran OK")
