#!@PYTHON@
# -*- python -*-
#
# (c) Mit authors 2018-2020
#
# This file is in the public domain.
#
# THIS PROGRAM IS PROVIDED AS IS, WITH NO WARRANTY. USE IS AT THE USERâ€™S
# RISK.

import os
import argparse

import mit@PACKAGE_SUFFIX@


# Process command-line arguments
parser = argparse.ArgumentParser(
    prog='mit-dump',
    description='Dump Mit object file (e.g. foo.obj) as hex (foo.hex) and disassembly (foo.asm).',
    formatter_class=argparse.RawDescriptionHelpFormatter
)
parser.add_argument(
    '--version',
    action='version',
    version='''\
%(prog)s @VERSION@
Copyright (c) Mit authors 2018-2020.
@PACKAGE_NAME@ comes with ABSOLUTELY NO WARRANTY.
You may redistribute copies of @PACKAGE_NAME@
under the terms of the MIT/X11 License.'''
)
parser.add_argument(
    'object_file',
    metavar='OBJECT-FILE',
    nargs='+',
    help='object file to use',
)
args = parser.parse_args()

# Dump files
for file in args.object_file:
    basename, ext = os.path.splitext(file)

    VM = mit.State()
    length = VM.load(file)

    asm_file = "{}.asm".format(basename)
    with open(asm_file, "w") as h:
        VM.disassemble(0, length, file=h)

    hex_file = "{}.hex".format(basename)
    with open(hex_file, "w") as h:
        VM.dump(0, length, file=h)
