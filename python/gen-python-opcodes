#!/usr/bin/env python3
# Generate instructions opcode list.
#
# (c) Mit authors 2018-2019
#
# The package is distributed under the MIT/X11 License.
#
# THIS PROGRAM IS PROVIDED AS IS, WITH NO WARRANTY. USE IS AT THE USER’S
# RISK.

import mit_core.vm_data as vm_data
from mit_core.code_util import Code, enum_to_python

import extra_instructions


code = Code()
code.append('''\
# Auto-generated by gen-python-opcodes - DO NOT EDIT.
# Instruction opcodes.
#
# (c) Mit authors 2018-2019
#
# The package is distributed under the MIT/X11 License.
#
# THIS PROGRAM IS PROVIDED AS IS, WITH NO WARRANTY. USE IS AT THE USER’S
# RISK.

from enum import Enum, IntEnum, unique
''')

register_code = Code('class Register(Enum):')
code.append('')
for register in vm_data.Register:
    register_code.append(Code('{} = object()'.format(register.name)))
code.extend(register_code)
code.append('')

code.extend(enum_to_python(vm_data.Instruction))
code.append('')

# The set of opcodes which must be the last in a word.
code.append('TERMINAL_OPCODES = frozenset({')
for name in [instruction.name
             for instruction in vm_data.Instruction
             if instruction.terminal]:
    code.append(Code('Instruction.{}, '.format(name)))
code.append('})')
code.append('')

code.extend(enum_to_python(vm_data.InternalExtraInstruction))
code.append('')

lib_code = Code('''\
    @unique
    class LibInstruction(Enum):
        def __init__(self, library, opcode):
            self.library = library
            self.opcode = opcode

        def __int__(self):
            return self.opcode''')
lib_code.append('')
for lib in extra_instructions.LibInstruction:
    lib_code.append(Code('{} = ({}, {:#x})'.format(lib.name, lib.library.__name__, lib.opcode)))
    code.extend(enum_to_python(lib.library))
    code.append('')
code.extend(lib_code)

print(code)
