#!/usr/bin/env python3
# Generate instructions opcode list.
#
# (c) Mit authors 2018-2019
#
# The package is distributed under the MIT/X11 License.
#
# THIS PROGRAM IS PROVIDED AS IS, WITH NO WARRANTY. USE IS AT THE USER’S
# RISK.

import mit_core.vm_data as vm_data
from mit_core.code_util import Code, enum_to_python
import mit_core.instruction_gen
mit_core.instruction_gen.TYPE_SIZE_UNKNOWN = 0

import extra_instructions


code = Code()
code.append('''\
# Auto-generated by gen-python-enums - DO NOT EDIT.
#
# Enumerations from the C API.
#
# (c) Mit authors 2018-2019
#
# The package is distributed under the MIT/X11 License.
#
# THIS PROGRAM IS PROVIDED AS IS, WITH NO WARRANTY. USE IS AT THE USER’S
# RISK.

from enum import Enum, IntEnum, unique
from .autonumber import AutoNumber
''')
code.append('')
code.append('')

register_code = Code(
    "'''",
    vm_data.Register.__doc__,
    "'''",
    '''\
        def __init__(self, read_only, type):
            self.read_only = read_only
            self.type = type
    ''',
)
for register in vm_data.Register:
    register_code.append('{} = ({}, "{}")'.format(
        register.name, register.read_only, register.type
    ))
code.append('class Register(AutoNumber):')
code.append(register_code)
code.append('')


code.extend(enum_to_python(
    vm_data.Instruction,
    lambda i: "{:#x}".format(i.opcode),
))
code.append('')

code.append('# The set of opcodes which must be the last in a word.')
code.append('TERMINAL_OPCODES = frozenset({')
for instruction in vm_data.Instruction:
    if instruction.terminal:
        code.append(Code('Instruction.{}, '.format(instruction.name)))
code.append('})')
code.append('')

code.extend(enum_to_python(
    vm_data.InternalExtraInstruction,
    lambda i: i.opcode,
))
code.append('')

lib_code = Code(
    "'''",
    extra_instructions.LibInstruction.__doc__,
    "'''",
    '''\
        def __init__(self, library, opcode):
            self.library = library
            self.opcode = opcode

        def __int__(self):
            return self.opcode
    ''',
)
lib_code.append('')
for lib in extra_instructions.LibInstruction:
    lib_code.append('{} = ({}, {:#x})'.format(
        lib.name,
        lib.library.__name__,
        lib.opcode,
    ))
    code.extend(enum_to_python(lib.library, lambda i: "{:#x}".format(i.value[0])))
    code.append('')
code.append('''\
    @unique
    class LibInstruction(Enum):
''')
code.append(lib_code)

code.append('')
code.extend(enum_to_python(vm_data.MitErrorCode))

print(code)
