version: "{build}"

# FIXME: currently does not work with IPython: get error "stdin is not a tty"
# when trying to test version of IPython in configure

environment:
  global:
    VERBOSE: 1 # Get test logs in output
  matrix:
    - APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu1804

    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      MSYSTEM: MSYS
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      MSYSTEM: MINGW64
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      MSYSTEM: MINGW32

init:
  - cmd: git config --global core.autocrlf input

install:
  - cmd: C:\msys64\usr\bin\bash.exe -lc "cd c:/projects/mit && ./build-aux/appveyor-install.sh"
  - sh: sudo apt-get update && sudo ACCEPT_EULA=Y DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y && sudo apt-get install -y texlive-latex-extra texlive-science texlive-fonts-recommended texlive-fonts-extra tex-gyre help2man latexmk hevea

# FIXME: In-place mit doesn't work, so remove  pforth after bootstrap
# (It would otherwise be tested on mingw32.)
build_script:
  - cmd: C:\msys64\usr\bin\bash.exe -lc "cd c:/projects/mit && ./bootstrap && rm -rf src/features/pforth && ./configure --enable-silent-rules && make && make install && make check"
  - sh: ./bootstrap && ./configure --enable-silent-rules --enable-package-suffix PY_LOG_ENV="LD_PRELOAD=/usr/lib/gcc/x86_64-linux-gnu/7/libasan.so PYTHONMALLOC=malloc" CFLAGS="-g3 -fsanitize=address -fsanitize=undefined" LDFLAGS="-fsanitize=address -fsanitize=undefined" && make check && make distcheck
