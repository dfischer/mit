#!/usr/bin/env python3

import re
import textwrap

from vm_data import Actions


# Variable creator
def make_vars(vars):
    code = []
    for i in vars:
        code.append('smite_WORD {var};'.format(var=i))
    return '\n'.join(code)

def pop_args(vars):
    code = []
    for i in reversed(vars):
        code.append('POP(&{var});'.format(var=i))
    return '\n'.join(code)

def push_results(vars):
    code = []
    for i in vars:
        code.append('PUSH({var});\n'.format(var=i))
    return '\n'.join(code)

print('// Auto-generated by gen-actions - DO NOT EDIT.\n')

print('''\
#define RAISE(code)                             \\
        do {                                    \\
            int error = (code);                 \\
            if (error != 0)                     \\
                return error;                   \\
        } while(0)

static int STEP(smite_state *S) {
    S->ITYPE = smite_decode_instruction(S, &S->PC, &S->I);
    trace(S->ITYPE, S->I);

    switch (S->ITYPE) {
    case INSTRUCTION_NUMBER:
        PUSH(S->I);
        break;
    case INSTRUCTION_ACTION:
        switch (S->I) {''')
for (instruction, action) in Actions.__members__.items():
    print('''\
        case O_{}:
            {{
{}
            }}
            break;'''.format(
        instruction,
        re.sub('\n\n+', '\n', textwrap.indent('\n'.join(['\n'.join([make_vars(action.value.args),
                                                                   make_vars(action.value.results),
                                                                   pop_args(action.value.args)]),
                                                        textwrap.dedent(action.value.code.rstrip()),
                                                        push_results(action.value.results)]), '                '),
               flags=re.MULTILINE).strip('\n')
    ))
print('''\
        default: /* Undefined instruction */
            return -1;
        }
        break;
    default: /* Error during instruction fetch */
        return S->ITYPE;
    }
    return 0;
}''')
