#!/usr/bin/env python3

from vm_data import Actions


# Variable creator
def make_vars(vars):
    code = ''
    for i in vars:
        code += '''\
smite_WORD {var};
'''.format(var=i)
    return code

def pop_args(vars):
    code = ''
    for i in reversed(vars):
        code += '''\
POP(&{var});
'''.format(var=i)
    return code

def push_results(vars):
    code = ''
    for i in vars:
        code += '''\
PUSH({var});
'''.format(var=i)
    return code

print('// Auto-generated by gen-actions - DO NOT EDIT.\n')

print('''\
#define RAISE(code)                             \\
        do {                                    \\
            int error = (code);                 \\
            if (error != 0)                     \\
                return error;                   \\
        } while(0)

static int STEP(smite_state *S) {
    S->ITYPE = smite_decode_instruction(S, &S->PC, &S->I);
    trace(S->ITYPE, S->I);

    switch (S->ITYPE) {
    case INSTRUCTION_NUMBER:
        PUSH(S->I);
        break;
    case INSTRUCTION_ACTION:
        switch (S->I) {''')
for (instruction, action) in Actions.__members__.items():
    print('''\
        case O_{}:
            {{
{}
{}
{}
{}
{}
            }}
            break;'''.format(
        instruction,
        make_vars(action.value.args),
        make_vars(action.value.results),
        pop_args(action.value.args),
        action.value.code.replace('        ', '                '),
        push_results(action.value.results),
    ))
print('''\
        default: /* Undefined instruction */
            return -1;
        }
        break;
    default: /* Error during instruction fetch */
        return S->ITYPE;
    }
    return 0;
}''')
