# Mit VM definition
#
# (c) Mit authors 1994-2020
#
# The package is distributed under the MIT/X11 License.
#
# THIS PROGRAM IS PROVIDED AS IS, WITH NO WARRANTY. USE IS AT THE USERâ€™S
# RISK.

# Error codes
ErrorCode:
  OK: 0
  INVALID_OPCODE: 1
  STACK_OVERFLOW: 2
  INVALID_STACK_READ: 3
  INVALID_STACK_WRITE: 4
  INVALID_MEMORY_READ: 5
  INVALID_MEMORY_WRITE: 6
  UNALIGNED_ADDRESS: 7
  BAD_SIZE: 8
  DIVISION_BY_ZERO: 9
  HALT: 127

# VM registers
Register:
  - pc
  - ir
  - stack_depth
  - stack
  - stack_words

# VM instruction instructions
Instruction:
  NEXT:
    opcode: 0x0
    args: []
    results: []
    terminal: true
  JUMP:
    opcode: 0x1
    args: ['addr']
    results: []
    terminal: true
  JUMPZ:
    opcode: 0x2
    args: ['flag', 'addr']
    results: []
  CALL:
    opcode: 0x3
    args: ['addr']
    results: ['ret_addr']
    terminal: true
  POP:
    opcode: 0x4
    args: ['ITEMS', 'COUNT']
    results: []
  DUP:
    opcode: 0x5
    args: ['x', 'ITEMS', 'COUNT']
    results: ['x', 'ITEMS', 'x']
  SWAP:
    opcode: 0x6
    args: ['x', 'ITEMS', 'y', 'COUNT']
    results: ['y', 'ITEMS', 'x']
  LOAD:
    opcode: 0x8
    args: ['addr', 'size']
    results: ['val']
  STORE:
    opcode: 0x9
    args: ['val', 'addr', 'size']
    results: []
  LIT:
    opcode: 0xa
    args: []
    results: ['n']
  LIT_PC_REL:
    opcode: 0xb
    args: []
    results: ['n']
  LIT_0:
    opcode: 0xc
    args: []
    results: ['n=0']
  LIT_1:
    opcode: 0xd
    args: []
    results: ['n=1']
  LIT_2:
    opcode: 0xe
    args: []
    results: ['n=2']
  LIT_3:
    opcode: 0xf
    args: []
    results: ['n=3']
  LT:
    opcode: 0x11
    args: ['a', 'b']
    results: ['flag']
  ULT:
    opcode: 0x12
    args: ['a', 'b']
    results: ['flag']
  NEGATE:
    opcode: 0x13
    args: ['a']
    results: ['r']
  ADD:
    opcode: 0x14
    args: ['a', 'b']
    results: ['r']
  MUL:
    opcode: 0x15
    args: ['a', 'b']
    results: ['r']
  DIVMOD:
    opcode: 0x16
    args: ['a', 'b']
    results: ['q', 'r']
  UDIVMOD:
    opcode: 0x17
    args: ['a', 'b']
    results: ['q', 'r']
  NOT:
    opcode: 0x18
    args: ['x']
    results: ['r']
  AND:
    opcode: 0x19
    args: ['x', 'y']
    results: ['r']
  OR:
    opcode: 0x1a
    args: ['x', 'y']
    results: ['r']
  XOR:
    opcode: 0x1b
    args: ['x', 'y']
    results: ['r']
  LSHIFT:
    opcode: 0x1c
    args: ['x', 'n']
    results: ['r']
  RSHIFT:
    opcode: 0x1d
    args: ['x', 'n']
    results: ['r']
  ARSHIFT:
    opcode: 0x1e
    args: ['x', 'n']
    results: ['r']
  SIGN_EXTEND:
    opcode: 0x1f
    args: ['u', 'size']
    results: ['n']

InternalExtraInstruction:
  HALT:
    opcode: 0x1
    args: []
    results: []
  GET_PC:
    opcode: 0x2
  SET_PC:
    opcode: 0x3
  GET_IR:
    opcode: 0x4
  SET_IR:
    opcode: 0x5
  GET_STACK_DEPTH:
    opcode: 0x6
  SET_STACK_DEPTH:
    opcode: 0x7
  GET_STACK:
    opcode: 0x8
  SET_STACK:
    opcode: 0x9
  GET_STACK_WORDS:
    opcode: 0xa
  SET_STACK_WORDS:
    opcode: 0xb
  CURRENT_STATE:
    opcode: 0xc
    args: []
    results: ['state:mit_state *']
  LOAD_STACK:
    opcode: 0xd
    args: ['pos', 'inner_state:mit_state *']
    results: ['value', 'ret']
  STORE_STACK:
    opcode: 0xe
    args: ['value', 'pos', 'inner_state:mit_state *']
    results: ['ret']
  POP_STACK:
    opcode: 0xf
    args: ['inner_state:mit_state *']
    results: ['value', 'ret']
  PUSH_STACK:
    opcode: 0x10
    args: ['value', 'inner_state:mit_state *']
    results: ['ret']
  NEW_STATE:
    opcode: 0x11
    args: ['stack_words']
    results: ['new_state:mit_state *']
  FREE_STATE:
    opcode: 0x12
    args: ['inner_state:mit_state *']
    results: []
  RUN:
    opcode: 0x13
    args: ['inner_state:mit_state *']
    results: ['ret']
  SINGLE_STEP:
    opcode: 0x14
    args: ['inner_state:mit_state *']
    results: ['ret']
