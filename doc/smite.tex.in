%
% The definition of @PACKAGE_NAME@ (self-contained paper)
%
% Reuben Thomas
%
% Started 1/6-29/10/93
%

\documentclass[a4paper]{article}
\usepackage[british]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{newpxtext,booktabs,hyperref}


% Macros for this document

% Font for stack pictures; macro \spic includes italic correction

\newcommand{\spic}[1]{\texttt{\textsl{#1\/}}}

% Common stack items

\newcommand{\x}[1]{\spic{x$_{#1}$}}
\newcommand{\n}[1]{\spic{n$_{#1}$}}
\newcommand{\U}[1]{\spic{u$_{#1}$}}
\newcommand{\noru}[1]{\spic{n$_#1${\tt |}u$_{#1}$}}
\newcommand{\aaddr}[1]{\spic{a-addr$_{#1}$}}

% Lay out an action definition

% Define the widths of the stack effect and description columns
\newlength{\itemwidth}\itemwidth=\textwidth \advance\itemwidth by -0.1in
\newlength{\instname}\instname=1.5in
\newlength{\stackcom}\stackcom=3.0in
\newlength{\beforestackcom} \advance\beforestackcom by \instname

\newcommand{\inst}[3]{\item[]\parbox{\itemwidth}%
{\makebox[\instname][l]{\tt #1}%
\makebox[\stackcom][r]{\tt ( \spic{#2} )}\\[0.5ex]#3}}

% Lay out an external interface call

\newlength{\innerwidth}\innerwidth=\itemwidth \advance\innerwidth by -0.5in
\newcommand{\iface}[4]{\item[]\parbox{\itemwidth}{{\bf #1} ({\it #2}\/) :
#3\\[0.5ex]\hspace*{0.4in}\parbox{\innerwidth}{#4}}}

% Lay out a line of the opcode table

\newcommand{\opcodetbl}[4]{0x#1 & {\tt #2} & 0x#3 & {\tt #4} \\}
\newcommand{\opcodetblone}[2]{0x#1 & {\tt #2} \\}


\title{The @PACKAGE_NAME@ Virtual Machine}
\author{Reuben Thomas}
\date{2nd February 2019}

\begin{document}
\maketitle

\subsection*{Typographical conventions}

Actions and registers are shown in {\tt Typewriter} font;
interface calls are shown in {\bf Bold} type, and followed by empty parentheses.

Addresses are given in bytes and refer to the VM address space except where
stated. Addresses are written in hexadecimal; hex numbers are prefixed with
“0x”.


\section{Introduction}

@PACKAGE_NAME@ is a simple virtual machine (VM) for study and experiment. It is a stack machine, based on the more complex register machine~\cite{mite0}.
This paper gives a full description of @PACKAGE_NAME@, but
certain implementation-dependent features are parametrized or
purposely left unspecified, and the exact method of implementation is left to
the implementor in many particulars.

@PACKAGE_NAME@ is self-contained. Machine
code routines on the host computer may be accessed using the {\tt CALL\_NATIVE}
action, which can also be used to implement I/O (see~\ref{accessact}). @PACKAGE_NAME@ supports a simple object module format.

@PACKAGE_NAME@ is conceptually (and usually in fact) a library, embedded in other programs.


\section{Architecture}

@PACKAGE_NAME@'s address unit is the byte, which is eight bits.
Words are {\tt WORD\_SIZE} bytes. The word is the size of the numbers
and addresses on which @PACKAGE_NAME@ operates, and of the items placed on the stack.
The size of the byte and range of word sizes allowed have been chosen with a view to making efficient implementation possible on the vast majority of current machine architectures.

Words may have the bytes stored in big-endian or little-endian order. The
address of a word is that of the byte in it with the lowest address.


\subsection{Registers}
\label{registers}

The registers, each with its function, are set out in table~\ref{regtable}.

\begin{table}[htbp]
\begin{center}
\begin{tabular}{cp{3.75in}} \toprule
\bf Register & \bf Function \\
    \midrule
{\tt PC} & The {\tt P}rogram {\tt C}ounter. Points to the next
    byte from which an instruction may be loaded. \\
{\tt F0} & The frame address of the bottom-most item of the current stack {\tt F}rame. \\
{\tt ITYPE} & The type of an instruction to be executed: $0$ for a number, and $1$ for an action. \\
{\tt I} & The {\tt I}nstruction. Holds the opcode of an instruction
    to be executed. \\
{\tt MEMORY\_SIZE} & The size in bytes of @PACKAGE_NAME@'s memory,
    which must be a whole number of words. \\
{\tt FRAME\_DEPTH} & The frame {\tt DEPTH} (number of items in the current frame). \\
{\tt ENDISM} & The endianness of @PACKAGE_NAME@: 0 = Little-endian,
    1 = Big-endian. \\
{\tt WORD\_SIZE} & The number of bytes in a word. Must be a power of $2$, and in the range $2$ to $32$ inclusive. \\
{\tt NATIVE\_POINTER\_SIZE} & The number of bytes in a host machine pointer (for {\tt CALL\_NATIVE}; see section~\ref{accessact}). \\
 \bottomrule
\end{tabular}
\caption{\label{regtable}Registers}
\end{center}
\end{table}

The registers are word quantities.

To ease efficient implementation, the registers may only be accessed
by actions (see section~\ref{registeract}); not all registers are accessible, and only a few are writable.


\subsection{Memory}

@PACKAGE_NAME@'s memory is a contiguous sequence of bytes with addresses in the range $0$ to {\tt MEMORY}~$-$~1.


\subsection{Stack}

The stack is a LIFO stack of frames. Each frame is a stack of words, and has a frame value that is typically a subroutine return address. To {\bf push} an item on to
the stack means to add a new item to the top of the frame, increasing the stack depth by $1$; to {\bf pop} an item means to reduce the stack depth by $1$. Actions that change the number of items in the frame implicitly pop their arguments and push their results.

Frame addresses are conceptually native addresses (and may be exactly native addresses), but must fit in a VM word. A valid frame address is the value of {\tt F0} of a currently-active frame.


\subsection{Operation}
\label{operation}

Before @PACKAGE_NAME@ is started, {\tt ENDISM} should be set to $0$ or $1$ according to the implementation, and {\tt WORD\_SIZE} and {\tt NATIVE\_POINTER\_SIZE} to the appropriate values. The other registers should be initialised to~$0$.

{\tt ENDISM}, {\tt WORD\_SIZE} and {\tt NATIVE\_POINTER\_SIZE} must not change while @PACKAGE_NAME@ is executing.

@PACKAGE_NAME@ is started by a call to the interface calls {\bf run()} or {\bf
single\_step()} (see section~\ref{calls}). In the former case, the execution
cycle is entered:

\begin{tabbing}
\hspace{0.5in}\=begin\=\+\+ \\*
decode the next instruction into {\tt I} from the bytes pointed to by {\tt PC} \\*
set {\tt PC} to point to the next byte after the end of the instruction\\*
execute the instruction in {\tt I} \- \\*
repeat
\end{tabbing}

In the latter case, the contents of the execution cycle is executed once, and
control returns to the calling program.

Note that the calls {\bf run()} and {\bf single\_step()} do not perform the
initialisation specified above.


\subsection{Termination}

When @PACKAGE_NAME@ encounters a {\tt HALT} action (see section~\ref{erroract}), execution terminates.

Reason codes which are also valid error codes (either reserved (see section~\ref{errors})
or user error codes) should not normally be used. This
allows error codes to be passed back to the calling
program, so that the calling program can handle certain errors without
confusing error codes and reason codes.


\subsection{Errors}
\label{errors}

Error conditions are dealt with by {\bf raising} an {\bf error}: the action
of {\tt HALT} is performed as if the error code had been given as its
argument. The instruction that caused the error to be raised is then
considered to have finished executing. Error codes are signed numbers. $-1$
to $-511$ are reserved for @PACKAGE_NAME@'s own error codes; the meanings of
those that may be raised by @PACKAGE_NAME@ are shown in
table~\ref{errortable}.

An error can be raised explicitly by {\tt HALT} (see section~\ref{erroract}); errors are also raised by various conditions, such as an attempt to access an invalid address, or divide by zero.

\begin{table}[htbp]
\begin{center}
\begin{tabular}{cl} \toprule
\bf Code & \bf Meaning \\ \midrule
$-9$ & Invalid address (see below). \\ % FIXME: distinguish between invalid memory, stack and frame addresses
$-10$ & Division by zero attempted (see section~\ref{arithmetic}). \\
$-23$ & Address alignment error (see below). \\
$-256$ & Invalid opcode (see section~\ref{opcodes}). \\ \bottomrule
\end{tabular}
\caption{\label{errortable}Errors raised by @PACKAGE_NAME@}
\end{center}
\end{table}

Error $-9$ is raised whenever an attempt is made to access an invalid
address, either by an
instruction, or during an instruction fetch (because {\tt PC} contains an
invalid address). Error $-23$ is raised when an action expecting
an address of type \spic{a-addr} (word-aligned) is given a non-aligned address.


\section{Instruction set}
\label{instset}

The instruction set is listed in sections~\ref{numbers} to~\ref{accessact},
with the instructions grouped according to function. The
instructions are given in the following format:

\begin{description}
\inst{NAME}{before — after}{Description.}
\end{description}

The first line consists of the name of the instruction. On the right is the
stack effect, which shows the effect of the instruction on the stack.
Underneath is the description.

{\bf Stack effects} are written

\centerline{\tt ( \spic{before — after} )}

\noindent where \spic{before} and \spic{after} are stack pictures showing the items on top of the stack before and after the instruction is executed. If the instruction adds or removes a frame, then the dash {\tt {\spic{--}}} is replaced by a vertical bar {\tt |}.
An instruction only affects the items shown in its
stack effects. The brackets and dashes serve merely to delimit the stack
effect and to separate \spic{before} from \spic{after}. {\bf Stack pictures}
are a representation of the top-most items on the stack, and are written

\centerline{\spic{i$_1$ i$_2$\dots i$_{n-1}$ i$_n$}}

\noindent where the \spic{i$_k$} are stack items, each of which occupies a whole number of
words, with \spic{i$_n$} being on top of the stack. The symbols denoting
different types of stack item are shown in table~\ref{typetable}.

\begin{table}[htbp]
\begin{center}
\begin{tabular}{cl} \toprule
\bf Symbol & \bf Data type \\ \midrule
\spic{flag} & a Boolean flag, $1$ for true and $0$ for false \\
\spic{byte} & byte \\
\spic{n} & signed number \\
\spic{u} & unsigned number \\
\spic{n{\tt |}u} & number (signed or unsigned) \\
\spic{x} & unspecified word \\
\spic{addr} & address \\
\spic{a-addr} & word-aligned address \\
\spic{f-addr} & frame address (may be a native address, but must fit in a single VM word) \\
\spic{n-addr} & native address \\
\bottomrule
\end{tabular}
\caption{\label{typetable}Types used in stack effects}
\end{center}
\end{table}

Types are only used to indicate how instructions treat their arguments and
results; @PACKAGE_NAME@ does not distinguish between stack items of different types. In
stack pictures the most general argument types with which each instruction can
be supplied are given; subtypes may be substituted. Using the phrase ``$i
\Rightarrow j$'' to denote ``$i$\/ is a subtype of $j$\/'', table~\ref{reltable}
shows the subtype relationships. The subtype relation is transitive.

\begin{table}[htbp]
\begin{center}
\begin{tabular}{c} \toprule
\spic{u} $\Rightarrow$ \spic{x} \\
\spic{n} $\Rightarrow$ \spic{x} \\
\spic{f-addr} $\Rightarrow$ \spic{x} \\
\spic{flag} $\Rightarrow$ \spic{u} \\
\spic{byte} $\Rightarrow$ \spic{u} \\
\spic{a-addr} $\Rightarrow$ \spic{addr} $\Rightarrow$ \spic{u} \\
 \bottomrule
\end{tabular}
\caption{\label{reltable}The subtype relation}
\end{center}
\end{table}

Numbers are represented in twos complement form. \spic{addr} consists of all
valid virtual machine addresses. Numeric constants can be included in
stack pictures, and are of type \spic{n{\tt |}u}. Native addresses may occupy more than one word, according to the values of {\tt WORD\_SIZE} and {\tt NATIVE\_POINTER\_SIZE}; the precise format of this address is implementation-dependent.

Each type may be suffixed by a number in stack pictures; if the same combination
of type and suffix appears more than once in a stack effect, it refers to
identical stack items. Alternative \spic{after} pictures are separated by ``{\tt
|}'', and the circumstances under which each occurs are detailed in the
instruction description.

The symbols \spic{i*x} and \spic{j*x} are used to denote different
collections of zero or more words of any data type. Ellipsis is used for
indeterminate numbers of specified types of word.


\subsection{Numbers}
\label{numbers}

\begin{description}
\inst{number}{— n}{The number is pushed on to the stack.}
\end{description}

\subsection{Stack manipulation}

These actions manage the stack.

\begin{description}
\inst{POP}{\x{u}\dots\x1 u —}{Remove \spic{u} items from the stack.}
\inst{DUP}{\x{u}\dots\x0 u — \x{u}\dots\x0 \x{u}}{Remove \spic{u}. Copy \x{u} to the top of the stack.}
\inst{SWAP}{\x{u}\dots\x0 u — \x0\x{u-1}\dots\x1 \x{u}}{Exchange the top stack item with the \spic{u}th. If \spic{u} is zero, do nothing.}
\end{description}

\subsection{Frame manipulation}

These actions manage the current frame and allow access to outer frames.

A memory error is raised for an invalid frame address or stack address.

\begin{description}
\inst{PUSH\_FRAME}{\x{u}\dots\x0 u x | \x{u}\dots\x0}{Push a new frame on the stack, with frame value \spic{x}, and move the \spic{u} top-most values of the old frame to the new frame.}
\inst{POP\_FRAME}{i*x | j*x i*x x}{Pops the top-most frame, pushing its stack items to the next outer frame, followed by the frame value \spic{x} of the popped frame.}
\inst{LOAD\_FRAME\_VALUE}{f-addr -- x}{Push the frame value \spic{x} of the frame whose address is \spic{f-addr}.}
\inst{LOAD\_OUTER\_F0}{f-addr$_1$ -- f-addr$_2$}{Push the frame address \spic{f-addr$_2$} of the next outer frame from the frame whose address is \spic{f-addr$_1$}.}
\inst{LOAD\_OUTER\_DEPTH}{f-addr -- u}{Push the number of items \spic{u} in the frame outside the frame whose address is \spic{f-addr}.}
\inst{FRAME\_DUP}{u f-addr -- \x}{Push the \spic{u}th item of the frame whose address is \spic{f-addr}.}
\inst{FRAME\_SWAP}{\x1 u f-addr -- \x2}{Exchange the stack item \x1 with the \spic{u}th item of the frame whose address is \spic{f-addr}.}
\inst{CALL\_FRAME}{\x{u}\dots\x0 u addr | \x{u}\dots\x0}{Perform the action of {\tt CALL}, then the action of {\tt PUSH\_FRAME}.}
\end{description}

\subsection{Comparison}

These words compare two numbers (or, for equality tests, any two words) on the
stack, returning a flag.

\begin{description}
\inst{LT}{\n1 \n2 — flag}{\spic{flag} is true if and only if \n1 is less than \n2.}
\inst{EQ}{\x1 \x2 — flag}{\spic{flag} is true if and only if \x1 is bit-for-bit the same as \x2.}
\inst{ULT}{\U1 \U2 — flag}{\spic{flag} is true if and only if \U1 is less than \U2.}
\end{description}


\subsection{Arithmetic}
\label{arithmetic}

These actions consist of monadic and dyadic operators.
All calculations are made without bounds or overflow checking, except
as detailed for certain actions.

Addition and negation:

\nopagebreak

\begin{description}
\inst{ADD}{\noru1 \noru2 — \noru3}{Add \noru2 to \noru1, giving the sum \noru3.}
\inst{NEGATE}{\n1 — \n2}{Negate \n1, giving its arithmetic inverse \n2.}
\end{description}

Multiplication and division (note that all division actions raise error
$-10$ if division by zero is attempted):

\nopagebreak

\begin{description}
\inst{MUL}{\noru1 \noru2 — \noru3}{Multiply \noru1 by \noru2 giving the product \noru3.}
\inst{UDIVMOD}{\U1 \U2 — \U3 \U4}{Divide \U1 by \U2, giving the single-word quotient \U3 and the single-word remainder \U4.}
\inst{DIVMOD}{\n1 \n2 — \n3 \n4}{Divide \n1 by \n2 using symmetric division, giving the single-word quotient \n3 and the single-word remainder \n4. The quotient is rounded towards zero.}
\end{description}


\subsection{Logic and shifts}

These actions consist of bitwise logical operators and bitwise shifts.

Logic functions:

\nopagebreak

\begin{description}
\inst{INVERT}{\x1 — \x2}{Invert all bits of \x1, giving its logical inverse \x2.}
\inst{AND}{\x1 \x2 — \x3}{\x3 is the bit-by-bit logical ``and'' of \x1 with \x2.}
\inst{OR}{\x1 \x2 — \x3}{\x3 is the bit-by-bit inclusive-or of \x1 with \x2.}
\inst{XOR}{\x1 \x2 — \x3}{\x3 is the bit-by-bit exclusive-or of \x1 with \x2.}
\end{description}

Shifts:

\nopagebreak

\begin{description}
\inst{LSHIFT}{\x1 u — \x2}{Perform a logical left shift of \spic{u} bit-places on \x1, giving \x2. Put zero into the least significant bits vacated by the shift. If \spic{u} is greater than or equal to the number of bits in a word, \x2 is zero.}
\inst{RSHIFT}{\x1 u — \x2}{Perform a logical right shift of \spic{u} bit-places on \x1, giving \x2. Put zero into the most significant bits vacated by the shift. If \spic{u} is greater than or equal to the number of bits in a word, \x2 is zero.}
\end{description}


\subsection{Memory}

These actions fetch and store words and bytes to and from memory; there is
also an action to add a number to another stored in memory.

\begin{description}
\inst{LOAD}{a-addr — x}{\spic{x} is the value stored at \spic{a-addr}.}
\inst{STORE}{x a-addr —}{Store \spic{x} at \spic{a-addr}.}
\inst{LOADB}{addr — byte}{Fetch the byte stored at \spic{addr}. The unused high-order bits are all zeroes.}
\inst{STOREB}{byte addr —}{Store \spic{byte} at \spic{addr}. Only one byte is transferred.}
\end{description}


\subsection{Registers}
\label{registeract}

\begin{description}
\inst{PUSH\_FRAME\_DEPTH}{— u}{\spic{u} is the value of {\tt FRAME\_DEPTH}.}
\inst{STORE\_FRAME\_DEPTH}{u —}{Set {\tt FRAME\_DEPTH} to \spic{u}.}
\inst{PUSH\_PC}{— addr}{Push {\tt PC} on to the stack.}
\inst{PUSH\_F0}{— f-addr}{Push the current frame address on to the stack.}
\inst{STORE\_F0}{f-addr —}{Set {\tt F0} to the given frame address.}
\inst{PUSH\_MEMORY}{— a-addr}{Push {\tt MEMORY} on to the stack.}
\inst{PUSH\_WORD\_SIZE}{— u}{\spic{u} is the value of {\tt WORD\_SIZE}.}
\inst{PUSH\_NATIVE\_POINTER\_SIZE}{— u}{\spic{u} is the value of {\tt NATIVE\_POINTER\_SIZE}.}
\end{description}


\subsection{Control structures}
\label{control}

These actions implement unconditional and conditional branches, and subroutine
call and return; there is also a no-op.

No-op:

\nopagebreak

\begin{description}
\inst{NOP}{—}{Do nothing.}
\end{description}

Branches:

\nopagebreak

\begin{description}
\inst{BRANCH}{addr —}{Set {\tt PC} to \spic{addr}.}
\inst{BRANCHZ}{flag addr —}{If \spic{flag} is false then set {\tt PC} to \spic{addr}.}
\end{description}

Subroutine call (return is {\tt BRANCH}):

\nopagebreak

\begin{description}
\inst{CALL}{\aaddr1 — \aaddr2}{Exchange {\tt PC} with the top stack value.}
\end{description}


\subsection{Errors}
\label{erroract}

This action gives access to @PACKAGE_NAME@'s error mechanism (see section~\ref{errors}).

\begin{description}
\inst{HALT}{x —}{Stop @PACKAGE_NAME@, returning reason code \spic{x} to the calling program (see section~\ref{calls}). If {\tt FRAME\_DEPTH} is $0$, $-257$ is returned as the reason code.}
\end{description}


\subsection{External access}
\label{accessact}

These actions allow access to @PACKAGE_NAME@'s libraries, the operating system and native machine code.

\begin{description}
\inst{CALL\_NATIVE}{n-addr —}{Make a subroutine call to the routine at address \spic{n-addr}, passing the current state as an argument.}
\inst{EXTRA}{i*x — j*x}{Perform implementation-dependent actions; for example, this can be used to implement system-dependent functionality such as I/O.}
\end{description}


\subsection{Instruction encoding}
\label{encoding}

Instructions are words encoded by one or more bytes, as follows: the significant bits of the number are split into groups of six bits, starting at the least significant end. The chunks are stored in consecutive bytes. All but the last byte have the seventh bit set and eighth bit clear. If the instruction is a number the final byte has the top two bits either both set or both clear, to match the number’s most significant bit; otherwise, the top bit is set and the second bit clear, to indicate an action.


\subsection{Action opcodes}
\label{opcodes}

Table~\ref{opcodetable} lists the action opcodes in numerical order. Other action opcodes are undefined. Undefined action opcodes raise error $-256$.

\begin{table}[htb]
\begin{center}
\begin{tabular}{*{2}{cc}} \toprule
\bf Opcode & \bf Action & \bf Opcode & \bf Action \\ \midrule
\opcodetbl{00}{NOP}	{16}{BRANCH}
\opcodetbl{01}{POP}	{17}{BRANCHZ}
\opcodetbl{02}{DUP}	{18}{CALL}
\opcodetbl{03}{SWAP}	{19}{HALT}
\opcodetbl{04}{LT}	{1a}{CALL\_NATIVE}
\opcodetbl{05}{EQ}	{1b}{EXTRA}
\opcodetbl{06}{ULT}	{1c}{PUSH\_WORD\_SIZE}
\opcodetbl{07}{ADD}	{1d}{PUSH\_NATIVE\_POINTER\_SIZE}
\opcodetbl{08}{NEGATE}	{1e}{PUSH\_FRAME\_DEPTH}
\opcodetbl{09}{MUL}	{1f}{STORE\_FRAME\_DEPTH}
\opcodetbl{0a}{UDIVMOD}	{20}{PUSH\_PC}
\opcodetbl{0b}{DIVMOD}	{21}{PUSH\_MEMORY}
\opcodetbl{0c}{INVERT}	{22}{PUSH\_F0}
\opcodetbl{0d}{AND}	{23}{STORE\_F0}
\opcodetbl{0e}{OR}	{24}{PUSH\_FRAME}
\opcodetbl{0f}{XOR}	{25}{POP\_FRAME}
\opcodetbl{10}{LSHIFT}	{26}{LOAD\_FRAME\_VALUE}
\opcodetbl{11}{RSHIFT}	{27}{LOAD\_OUTER\_F0}
\opcodetbl{12}{LOAD}	{28}{LOAD\_OUTER\_DEPTH}
\opcodetbl{13}{STORE}   {29}{FRAME\_DUP}
\opcodetbl{14}{LOADB}   {2a}{FRAME\_SWAP}
\opcodetbl{15}{STOREB}  {2b}{CALL\_FRAME}
 \bottomrule
\end{tabular}
\caption{\label{opcodetable}Action opcodes}
\end{center}
\end{table}


\section{External interface}

@PACKAGE_NAME@'s external interface comes in three parts. The calling interface allows
@PACKAGE_NAME@ to be controlled by other programs. The {\tt CALL\_NATIVE} action (see section~\ref{accessact}) allows implementations to provide access to system facilities, previously written code,
code written in other languages, and the speed of machine code in time-critical
situations. The object module format allows compiled code to be saved, reloaded
and shared between systems.


\subsection{Object module format}
\label{object}

The object module starts with the ASCII codes of the letters
``@PACKAGE@'' padded to eight bytes by ASCII NULs (0x00), then values of
the {\tt ENDISM} and {\tt WORD\_SIZE} registers of the system which saved the module, then the number of bytes the code occupies. These values are all encoded as in section~\ref{encoding}. Then follows the code.

Object modules have a simple structure, as they are only intended for loading an
initial memory image into @PACKAGE_NAME@.


\subsection{Calling interface}
\label{calls}

The calling interface is difficult to specify with the same precision as the
rest of @PACKAGE_NAME@, as it may be implemented in any language. However, since only
basic types are used, and the semantics are simple, it is expected that
implementations in different language producing the same result will be easy to
program. A Modula-like syntax is used to give the definitions here.
Implementation-defined error codes must be documented, but are optional. All
addresses passed as parameters must be word-aligned. An implementation of @PACKAGE_NAME@ must provide the
following calls:

\begin{description}
\iface{native\_address}{integer, boolean}{pointer}{Return a native pointer corresponding
    to the given VM address. If the address is invalid, or the Boolean flag is true and the address is read-only, then a distinguished invalid pointer is returned.}
\iface{run}{}{integer}{Start @PACKAGE_NAME@ by entering the execution cycle as
    described in section~\ref{operation}. If @PACKAGE_NAME@ ever executes a {\tt
    HALT} action (see section~\ref{erroract}), the reason code is
    returned as the result.}
\iface{single\_step}{}{integer}{Execute a single pass of the execution
    cycle, and return reason code $-257$, unless a {\tt HALT} action was
    obeyed (see section~\ref{erroract}), in which case the reason code
    passed to it is returned.}
\iface{load\_object}{file, address}{integer}{Load the object module
    specified by \textit{file}, which may be a filename or some other
    specifier, to the VM address \textit{address}. First the module's
    header is checked; if the first seven bytes are not as specified above
    in section~\ref{object}, or the endianness value is not 0 or 1, then
    return $-2$. If the code will not fit into memory at the address given, or
    the address is out of range or unaligned, return $-1$. Otherwise load the code into
    memory, converting it if the endianness value is different from the current
    value of {\tt ENDISM}. The result is the length of the code in bytes if successful, and some other
    implementation-defined value if there is a filing system or other error.}
\end{description}

@PACKAGE_NAME@ must also provide access to its registers and address space through
appropriate data objects.


\section*{Acknowledgements}

Martin Richards's demonstration of his BCPL-oriented Cintcode virtual machine~\cite{cintweb}
convinced me it was going to be fun working on virtual machines. He also supervised my BA dissertation project, Beetle~\cite{beetledis}, on which @PACKAGE_NAME@ is based.

\bibliographystyle{plain}
\bibliography{vm,rrt}


\end{document}

% LocalWords:  discontiguous Richards's
